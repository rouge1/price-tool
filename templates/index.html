<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .hover-zoom {
            transition: transform 0.2s;
        }
        .hover-zoom:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid"></div>
            <a class="navbar-brand" href="#">Price Tool</a>
            <div class="ms-auto">
                <button class="btn btn-link text-light settings-btn" data-bs-toggle="modal" data-bs-target="#settingsModal">
                    <i class="fas fa-gear fa-lg"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Add New Item Card -->
            <div class="col-12 mb-4">
                <div class="card shadow-sm hover-card add-item-card" data-bs-toggle="modal" data-bs-target="#addItemModal">
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <i class="fas fa-plus fa-2x text-muted"></i>
                    </div>
                </div>
            </div>
            
            <!-- Existing Items -->
            {% for website in websites %}
            <div class="col-12 mb-4">
                <div class="card shadow-sm hover-card">
                    <div class="card-body position-relative"> <!-- Add position-relative here -->
                        <!-- Delete button -->
                        <button class="btn btn-link text-danger delete-btn position-absolute top-0 end-0 mt-2 me-2"
                                onclick="confirmDelete('{{ website.url }}')">
                            <i class="fas fa-trash"></i>
                        </button>
                        
                        <div class="row">
                            <!-- Thumbnail Column - increased to col-md-4 -->
                            <div class="col-md-4">
                                <div class="item-thumbnail">
                                    <a href="{{ website.url }}" target="_blank" rel="noopener noreferrer">
                                        {% if website.image_data %}
                                            <img src="data:image/jpeg;base64,{{ website.image_data|b64encode }}" 
                                                 class="img-fluid rounded hover-zoom" 
                                                 alt="Item thumbnail"
                                                 style="cursor: pointer;">
                                        {% else %}
                                            <img src="https://via.placeholder.com/400" 
                                                 class="img-fluid rounded hover-zoom" 
                                                 alt="No image"
                                                 style="cursor: pointer;">
                                        {% endif %}
                                    </a>
                                </div>
                            </div>
                            <!-- Content Column - adjusted to col-md-2 -->
                            <div class="col-md-2">
                                <div class="d-flex align-items-start">
                                    <h5 class="card-title mb-0 me-2">{{ website.description or 'New Item' }}</h5>
                                    <button class="btn btn-link btn-sm p-0 mt-1 edit-description" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editDescriptionModal"
                                            data-url="{{ website.url }}"
                                            data-description="{{ website.description }}">
                                        <i class="fas fa-pencil text-muted"></i>
                                    </button>
                                </div>
                                <div class="price-info">
                                    <span class="current-price">{{ website.currency }}{{ "%.2f"|format(website.current_price or 0) }}</span>
                                </div>
                            </div>
                            <!-- Graph Column remains col-md-6 -->
                            <div class="col-md-6">
                                <div class="price-graph">
                                    <div class="graph-placeholder">
                                        Price history coming soon
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Add URL Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Add New Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-2">
                    <form id="addItemForm" class="needs-validation" novalidate>
                        <div class="form-floating mb-3">
                            <input type="url" class="form-control" id="itemUrl" placeholder="https://..." required>
                            <label for="itemUrl">Enter item URL</label>
                        </div>
                        <div class="alert alert-danger d-none" id="errorMessage"></div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitButton">Add Item</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Settings content coming soon...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this item?</p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Description Modal -->
    <div class="modal fade" id="editDescriptionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Edit Description</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editDescriptionForm">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="itemDescription" required>
                            <label for="itemDescription">Item Description</label>
                        </div>
                        <input type="hidden" id="itemUrl">
                        <div class="alert alert-danger d-none" id="editErrorMessage"></div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveDescriptionBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('addItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const url = document.getElementById('itemUrl').value;
            const errorMessage = document.getElementById('errorMessage');
            const submitButton = document.getElementById('submitButton');

            errorMessage.classList.add('d-none');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';

            if (url) {
                try {
                    const response = await fetch('/add-item', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ url: url })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
                        modal.hide();
                        window.location.reload();
                    } else {
                        errorMessage.textContent = data.error || 'Error adding item';
                        errorMessage.classList.remove('d-none');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    errorMessage.textContent = 'Network error occurred. Please try again.';
                    errorMessage.classList.remove('d-none');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Add Item';
                }
            }
        });

        // Clear error message when modal is hidden
        document.getElementById('addItemModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('errorMessage').classList.add('d-none');
            document.getElementById('itemUrl').value = '';
            document.getElementById('submitButton').disabled = false;
            document.getElementById('submitButton').innerHTML = 'Add Item';
        });

        let urlToDelete = '';
        
        function confirmDelete(url) {
            urlToDelete = url;
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/delete-item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: urlToDelete })
                });
                
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Error deleting item');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting item');
            }
        });

        // Edit description handling
        document.addEventListener('DOMContentLoaded', function() {
            const editModal = document.getElementById('editDescriptionModal');
            const editForm = document.getElementById('editDescriptionForm');
            const descInput = document.getElementById('itemDescription');
            const urlInput = document.getElementById('itemUrl');
            const errorMessage = document.getElementById('editErrorMessage');
            
            // When edit button is clicked
            document.querySelectorAll('.edit-description').forEach(button => {
                button.addEventListener('click', function() {
                    const url = this.dataset.url;
                    const description = this.dataset.description;
                    descInput.value = description;
                    urlInput.value = url;
                    errorMessage.classList.add('d-none');
                });
            });
            
            // When save button is clicked
            document.getElementById('saveDescriptionBtn').addEventListener('click', async function() {
                if (!descInput.value.trim()) {
                    errorMessage.textContent = 'Description cannot be empty';
                    errorMessage.classList.remove('d-none');
                    return;
                }
                
                try {
                    const response = await fetch('/update-description', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            url: urlInput.value,
                            description: descInput.value.trim()
                        })
                    });
                    
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        const data = await response.json();
                        errorMessage.textContent = data.error || 'Error updating description';
                        errorMessage.classList.remove('d-none');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    errorMessage.textContent = 'Network error occurred';
                    errorMessage.classList.remove('d-none');
                }
            });
        });
    </script>
</body>
</html>
